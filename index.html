<!DOCTYPE html>
<html>
<head>
    <!--
      If you are serving your web app in a path other than the root, change the
      href value below to reflect the base path you are serving from.

      The path provided below has to start and end with a slash "/" in order for
      it to work correctly.

      For more details:
      * https://developer.mozilla.org/en-US/docs/Web/HTML/Element/base

      This is a placeholder for base href that will be replaced by the value of
      the `--base-href` argument provided to `flutter build`.
    -->
    <base href="">

    <meta charset="https://zafergunal.github.io/practico_test/">
    <meta content="IE=Edge" http-equiv="X-UA-Compatible">
    <meta name="description" content="Testing Platform">

    <!-- iOS meta tags & icons -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="PractiCo">
    <link rel="apple-touch-icon" href="../assets/soleLogoIco.ico">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../assets/soleLogoIco.ico"/>

    <title>untitled5</title>
    <link rel="manifest" href="manifest.json">
</head>
<body>
<!--
  You can customize the "flutter_bootstrap.js" script.
  This is useful to provide a custom configuration to the Flutter loader
  or to give the user feedback during the initialization process.

  For more details:
  * https://docs.flutter.dev/platform-integration/web/initialization
-->
<script src="flutter_bootstrap.js" async></script>

<!-- âœ… SESSION MANAGEMENT & HEARTBEAT SYSTEM -->
<script>
    console.log('ğŸ”§ Initializing session management...');

    // âœ… Sayfa kapatÄ±lÄ±rken logout
    window.addEventListener('beforeunload', function(e) {
      // Flutter SharedPreferences web'de 'flutter.' prefix'i kullanÄ±r
      const token = localStorage.getItem('flutter.auth_token');

      if (token) {
        console.log('ğŸ”´ Page closing - sending logout signal');

        // âœ… navigator.sendBeacon kullan (beforeunload'da async Ã§alÄ±ÅŸmaz)
        const blob = new Blob(
          [JSON.stringify({ })],
          { type: 'application/json' }
        );

        navigator.sendBeacon(
          'https://testauth-153e5c716660.herokuapp.com/logout',
          blob
        );

        // Token'Ä± temizle
        localStorage.removeItem('flutter.auth_token');
      }
    });

    // âœ… Heartbeat sistemi
    let heartbeatTimer = null;
    let currentToken = null;

    // Flutter'dan Ã§aÄŸrÄ±lacak fonksiyon
    window.startHeartbeat = function(token) {
      if (!token) {
        console.warn('âš ï¸ Cannot start heartbeat - no token provided');
        return;
      }

      // Ã–nce eski timer'Ä± durdur
      window.stopHeartbeat();

      currentToken = token;
      console.log('ğŸ’“ Starting web heartbeat system...');

      // Ä°lk heartbeat'i hemen gÃ¶nder
      sendHeartbeat(token);

      // Sonra her 30 saniyede bir gÃ¶nder
      heartbeatTimer = setInterval(function() {
        sendHeartbeat(token);
      }, 30000); // 30 saniye
    };

    window.stopHeartbeat = function() {
      if (heartbeatTimer) {
        console.log('ğŸ”´ Stopping web heartbeat');
        clearInterval(heartbeatTimer);
        heartbeatTimer = null;
        currentToken = null;
      }
    };

    // Heartbeat gÃ¶nderme fonksiyonu
    function sendHeartbeat(token) {
      fetch('https://testauth-153e5c716660.herokuapp.com/heartbeat', {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + token,
          'Content-Type': 'application/json'
        }
      })
      .then(function(res) {
        if (res.ok) {
          console.log('âœ… Heartbeat sent successfully');
        } else if (res.status === 401) {
          console.warn('âš ï¸ Session expired (401) - stopping heartbeat');
          window.stopHeartbeat();

          // Session expired mesajÄ± gÃ¶ster (Flutter tarafÄ±nda handle edilecek)
          if (window.flutter_inappwebview) {
            window.flutter_inappwebview.callHandler('sessionExpired');
          }
        } else {
          console.warn('âš ï¸ Heartbeat failed with status:', res.status);
        }
      })
      .catch(function(err) {
        console.error('âŒ Heartbeat error:', err);
      });
    }

    // âœ… Sekme/pencere focus kontrolÃ¼ (optional - performans iÃ§in)
    document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
        console.log('ğŸ“´ Tab hidden - heartbeat continues in background');
      } else {
        console.log('ğŸ“± Tab visible - heartbeat active');
        // Sekme aktif olduÄŸunda hemen bir heartbeat gÃ¶nder
        if (currentToken && heartbeatTimer) {
          sendHeartbeat(currentToken);
        }
      }
    });

    console.log('âœ… Session management initialized');
</script>

</body>
</html>
